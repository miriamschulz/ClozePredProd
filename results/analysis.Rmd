---
title: "Analysis"
author: "Miriam Schulz"
date: "2025-01-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Preliminaries

Libraries: 

```{r, message = FALSE}
# Preliminaries
rm(list = ls())
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(Rmisc)
library(lme4)
```

Custom functions:

```{r}
extract_regions <- function(df) {
  df <- filter(df, WordPosition %in% c("5", "6", "7", "8"))
  df <- filter(df, ExpItemType == "ExpItem")
  df$RT <- as.numeric(df$RT)
  df$ExpCondition <- as.factor(df$ExpCondition)
  print(mean(df$RT))
  df %>%
    dplyr::group_by(ExpCondition) %>%
    dplyr::summarise(mean_RT = mean(RT, na.rm = TRUE)) %>%
    print()
  return(df)
}

remove_outliers <- function(df) {
  nrow_orig <- nrow(df)
  df <- filter(df, RT > 80 & RT < 2500)
  nrow_new <- nrow(df)
  nrow_diff <- nrow_orig-nrow_new
  cat("Number of data points eliminated:", nrow_diff, "out of", nrow_orig)
  cat("  (", nrow_diff / nrow_orig * 100, "%)", sep="")
  return(df)
}
```


Read data:

```{r}
# Read preprocessed dfs
dat <- read.csv("results_preprocessed.csv", header=TRUE)
```


Extract critical regions & first check of mean RT by condition:

```{r}
dat <- extract_regions(dat)
```


Completeness checks:

```{r}
xtabs(~ UniqueID + ExpCondition, filter(dat, WordPosition == TargetPosition))
```



# Outlier elimination

Check for outliers:

```{r}
hist(dat$RT, breaks=25, col="steelblue")

range(dat$RT)

# sort(dat$RT)
```

Remove trials with extreme RTs:

```{r}
dat <- remove_outliers(dat)
```


# Accuracy, answer time and production time

TODO:

- check accuracy by subject
- basic plot for comprehension question RT (histogram + by condition) 
- and for production timeouts (including fillers!?)

```{r}
hist(dat$AnswerTime, breaks=25, col="steelblue")
```


# Plots

## Bar plots of the target region

Plot by condition with confidence intervals:

```{r}
# Generate a summary data frame including the SE:
dat.plot <- summarySE(filter(dat, WordPosition == TargetPosition),
                      measurevar="RT",
                      groupvars=c("ExpCondition", "Task"),
                      na.rm=T)

# Determine maximal value for y-axis:
max_y <- max(c(dat.plot$RT + dat.plot$se))

# Plot:
ggplot(data=dat.plot,
       aes(ExpCondition, RT, fill=ExpCondition)) + 
  geom_bar(aes(fill=ExpCondition),
           stat="identity",
           width=1,
           show.legend=TRUE) +
  geom_errorbar(aes(ymin = RT-se, ymax = RT+se),
              width=0.1, linewidth=0.3) +
  # xlab("Condition") +
  ylab("Reading Time (ms)") +
  ggtitle("Reading Time by Task") +
  scale_fill_manual(values=c("navy", "steelblue1")) +
  ylim(0, max_y) +
  theme_minimal() + 
  theme(
      axis.title.x = element_text(size = 14, face = 'bold'),
      axis.title.y = element_text(size = 14, face = 'bold'),
      axis.text.x = element_text(size = 12, face = 'bold', color = 'black'),
      axis.text.y = element_text(size = 12, color = 'black'),
      plot.title = element_text(size = 25, face = 'bold'),
      legend.position = "none",
      strip.text = element_text(size = 18, face = "bold")) + 
  facet_wrap(~Task)

ggsave("./plots/RTs_target_barplot.png", plot = last_plot(), width=6, height=4, dpi=320)
```


## Line plot of all regions

```{r}
# Generate a summary data frame including the SE:
#dat$WordPosition <- as.factor(dat$WordPosition)
dat.plot <- summarySE(dat,
                      measurevar="RT",
                      groupvars=c("WordPosition", "ExpCondition", "Task"),
                      na.rm=T)
dat.plot$Region <- rep(c("pre-critical", "target", "spill1", "spill2"), each=4)
dat.plot$Region <- factor(dat.plot$Region, levels=c("pre-critical", "target",
                                                    "spill1", "spill2"))

ggplot(data = dat.plot,
       aes(x = Region,
           y = RT,
           color = ExpCondition,
           group = ExpCondition)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = RT - se, ymax = RT + se), 
                width = 0.2, 
                linewidth = 0.5) +
  facet_wrap(~Task) +
  labs(color = "Expectancy") +
  xlab("Region") +
  ylab("Reading Time (ms)") +
  ggtitle("Reading Times by Region") +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    plot.title = element_text(size = 20, face = "bold"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 16, face = "bold")
  ) +
  scale_color_manual(values = c("navy", "steelblue1"))  # Custom colors

ggsave("./plots/RTs.png", plot = last_plot(), width=10, height=7, dpi=320)
```

## More plots

TODO: Make individual plots:

- by subject
- by item
- by list?
- by Block Order!
- RT by time aka. trial number (+cond / +subject)


# Model

```{r}
dat$Item <- as.factor(dat$ExpItemNum)
dat$Subject <- as.factor(dat$UniqueID)
dat$Expectancy <- as.factor(dat$ExpCondition)
contrasts(dat$Expectancy) <- c(-0.5, 0.5)
dat$Task <- as.factor(dat$Task)
contrasts(dat$Task) <- c(-0.5, 0.5)
dat$logRT <- log(dat$RT)
dat$ClozeCentered <- scale(dat$ClozeProb)

#TODO: residualize for word length + frequency?

# Baby LM with binary Expectancy predictor:
summary(lm(logRT ~ Expectancy * Task + TargetLength + TargetFreq,
           data = filter(dat, WordPosition == TargetPosition)))

# Baby LM with binary Expectancy predictor:
m_target <- lm(logRT ~ ClozeCentered * Task + TargetLength + TargetFreq,
           data = filter(dat, WordPosition == TargetPosition))
summary(m_target)

# anova(m2, m3)
# summary(rePCA(m2))
```

